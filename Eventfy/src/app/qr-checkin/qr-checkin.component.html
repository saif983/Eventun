<app-navbar></app-navbar>

<div class="qr-checkin-container">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <!-- Header -->
    <div class="text-center mb-12">
      <h1 class="text-4xl font-bold text-gray-900 mb-4">
        <i class="fas fa-qr-code text-purple-600 mr-3"></i>
        QR Code Check-in System
      </h1>
      <p class="text-xl text-gray-600 max-w-3xl mx-auto">
        Scan and verify event tickets using QR codes. Upload an image or provide a URL to validate ticket authenticity and check in attendees.
      </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
      <!-- Scanner Section -->
      <div class="scanner-section">
        <div class="bg-white rounded-lg shadow-lg p-8">
          <h2 class="text-2xl font-semibold text-gray-900 mb-6">
            <i class="fas fa-camera text-purple-600 mr-2"></i>
            Scan QR Code
          </h2>

          <form [formGroup]="checkinForm" class="space-y-6">
            <!-- File Upload Method -->
            <div class="scan-method">
              <h3 class="text-lg font-medium text-gray-900 mb-4">Method 1: Upload QR Code Image</h3>
              <div class="upload-area">
                <input 
                  type="file" 
                  id="qrFile" 
                  accept="image/*"
                  (change)="onFileSelected($event)"
                  class="hidden">
                <label 
                  for="qrFile" 
                  class="upload-label">
                  <i class="fas fa-cloud-upload-alt text-4xl text-purple-600 mb-4"></i>
                  <p class="text-lg font-medium text-gray-900 mb-2">Click to upload QR code image</p>
                  <p class="text-sm text-gray-600">PNG, JPG, GIF up to 1MB</p>
                </label>
              </div>
            </div>

            <!-- URL Method -->
            <div class="scan-method">
              <h3 class="text-lg font-medium text-gray-900 mb-4">Method 2: QR Code URL</h3>
              <div class="form-group">
                <label for="qrCodeUrl" class="form-label">QR Code Image URL</label>
                <input 
                  type="url" 
                  id="qrCodeUrl" 
                  formControlName="qrCodeUrl"
                  class="form-input"
                  placeholder="https://example.com/qrcode.png">
                <div *ngIf="checkinForm.get('qrCodeUrl')?.invalid && checkinForm.get('qrCodeUrl')?.touched" class="error-message">
                  Please enter a valid URL starting with http:// or https://
                </div>
              </div>
              <button 
                type="button"
                (click)="scanQRCodeFromUrl()"
                [disabled]="checkinForm.get('qrCodeUrl')?.invalid || isScanning"
                class="btn-primary mt-4">
                <i class="fas fa-search mr-2"></i>
                Scan from URL
              </button>
            </div>

            <!-- Camera Method -->
            <div class="scan-method">
              <h3 class="text-lg font-medium text-gray-900 mb-4">Method 3: Use Camera</h3>
              <div class="flex items-center gap-3 mb-4">
                <button type="button" class="btn-primary" (click)="startCamera()" [disabled]="isCameraActive">
                  <i class="fas fa-video mr-2"></i>
                  Start Camera
                </button>
                <button type="button" class="btn-secondary" (click)="stopCamera()" [disabled]="!isCameraActive">
                  <i class="fas fa-stop mr-2"></i>
                  Stop Camera
                </button>
              </div>
              <!-- Camera selector -->
              <div class="form-group" *ngIf="(cameras?.length ?? 0) > 0">
                <label class="form-label">Camera</label>
                <select class="form-input" [value]="selectedDeviceId || ''" (change)="onCameraChange($any($event.target).value)">
                  <option [value]="''">Auto (best available)</option>
                  <option *ngFor="let cam of cameras" [value]="cam.deviceId">{{ cam.label || 'Camera' }}</option>
                </select>
              </div>
              <div class="camera-preview" *ngIf="isCameraActive">
                <video #videoEl class="video" playsinline muted></video>
                <canvas #canvasEl class="hidden-canvas"></canvas>
                <p class="text-sm text-gray-500 mt-2">
                  Point your camera at a QR code. Scanning happens automatically every second.
                </p>
              </div>
              <div class="text-sm text-gray-500 mt-2" *ngIf="!isCameraActive">
                Grant camera permission in your browser when prompted. If blocked, enable it from site settings.
              </div>
            </div>

            <!-- Reset Button -->
            <div class="flex justify-center pt-4">
              <button 
                type="button"
                (click)="resetForm()"
                class="btn-secondary">
                <i class="fas fa-refresh mr-2"></i>
                Reset Scanner
              </button>
            </div>
          </form>

          <!-- Loading State -->
          <div *ngIf="isScanning" class="loading-section">
            <div class="flex items-center justify-center py-8">
              <div class="loading-spinner mr-3"></div>
              <span class="text-gray-600">Scanning QR code...</span>
            </div>
          </div>

          <!-- Error Messages -->
          <div *ngIf="errorMessage" class="error-alert">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            {{ errorMessage }}
          </div>

          <!-- Success Messages -->
          <div *ngIf="successMessage" class="success-alert">
            <i class="fas fa-check-circle mr-2"></i>
            {{ successMessage }}
          </div>
        </div>
      </div>

      <!-- Results Section -->
      <div class="results-section">
        <div class="bg-white rounded-lg shadow-lg p-8">
          <h2 class="text-2xl font-semibold text-gray-900 mb-6">
            <i class="fas fa-ticket-alt text-purple-600 mr-2"></i>
            Scan Results
          </h2>

          <!-- No Results State -->
          <div *ngIf="!scanResult && !isScanning" class="no-results">
            <div class="text-center py-12">
              <i class="fas fa-qrcode text-6xl text-gray-300 mb-4"></i>
              <p class="text-gray-500 text-lg">No QR code scanned yet</p>
              <p class="text-gray-400 text-sm">Upload an image or provide a URL to get started</p>
            </div>
          </div>

          <!-- Ticket Information -->
          <div *ngIf="ticketData" class="ticket-info">
            <div class="ticket-card" [ngClass]="{'valid-ticket': isValidTicket, 'invalid-ticket': !isValidTicket}">
              <div class="ticket-header">
                <h3 class="ticket-title">{{ ticketData.eventName }}</h3>
                <span class="ticket-status" [ngClass]="{'status-valid': isValidTicket, 'status-invalid': !isValidTicket}">
                  <i class="fas" [ngClass]="{'fa-check-circle': isValidTicket, 'fa-times-circle': !isValidTicket}"></i>
                  {{ isValidTicket ? 'Valid Ticket' : 'Invalid/Used' }}
                </span>
              </div>

              <div class="ticket-details">
                <div class="detail-row">
                  <span class="label">Ticket ID:</span>
                  <span class="value">{{ ticketData.ticketId }}</span>
                </div>
                <div class="detail-row">
                  <span class="label">Date:</span>
                  <span class="value">{{ ticketData.eventDate }}</span>
                </div>
                <div class="detail-row">
                  <span class="label">Time:</span>
                  <span class="value">{{ ticketData.eventTime }}</span>
                </div>
                <div class="detail-row">
                  <span class="label">Location:</span>
                  <span class="value">{{ ticketData.eventLocation }}</span>
                </div>
                <div class="detail-row">
                  <span class="label">Type:</span>
                  <span class="value">{{ ticketData.ticketType }}</span>
                </div>
                <div class="detail-row">
                  <span class="label">Price:</span>
                  <span class="value">${{ ticketData.ticketPrice }}</span>
                </div>
                <div class="detail-row">
                  <span class="label">Organizer:</span>
                  <span class="value">{{ ticketData.organizerName }}</span>
                </div>
              </div>

              <!-- Check-in Button -->
              <div *ngIf="isValidTicket" class="checkin-actions">
                <button 
                  (click)="checkInTicket()"
                  class="btn-success">
                  <i class="fas fa-check mr-2"></i>
                  Check In Attendee
                </button>
              </div>
            </div>
          </div>

          <!-- Raw QR Data (for debugging) -->
          <div *ngIf="scanResult && !ticketData" class="raw-data">
            <h4 class="text-lg font-medium text-gray-900 mb-3">Raw QR Code Data:</h4>
            <div class="bg-gray-100 p-4 rounded-lg">
              <code class="text-sm text-gray-800 break-all">{{ scanResult }}</code>
            </div>
            <p class="text-sm text-gray-600 mt-2">
              This QR code doesn't contain valid ticket data format.
            </p>
          </div>
        </div>

        <!-- Statistics Section -->
        <div class="bg-white rounded-lg shadow-lg p-8 mt-8">
          <h2 class="text-2xl font-semibold text-gray-900 mb-6">
            <i class="fas fa-chart-bar text-purple-600 mr-2"></i>
            Check-in Statistics
          </h2>

          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-number">{{ checkedInTickets.length }}</div>
              <div class="stat-label">Total Check-ins</div>
            </div>
          </div>

          <!-- Management Actions -->
          <div class="management-actions">
            <button 
              (click)="exportCheckedInList()"
              [disabled]="checkedInTickets.length === 0"
              class="btn-primary mr-4">
              <i class="fas fa-download mr-2"></i>
              Export Report
            </button>
            <button 
              (click)="clearCheckedInHistory()"
              [disabled]="checkedInTickets.length === 0"
              class="btn-danger">
              <i class="fas fa-trash mr-2"></i>
              Clear History
            </button>
          </div>

          <!-- Recent Check-ins -->
          <div *ngIf="checkedInTickets.length > 0" class="recent-checkins">
            <h4 class="text-lg font-medium text-gray-900 mb-3">Recent Check-ins</h4>
            <div class="checkin-list">
              <div *ngFor="let ticketId of checkedInTickets.slice(-10).reverse()" class="checkin-item">
                <i class="fas fa-ticket-alt text-green-600 mr-2"></i>
                <span class="ticket-id">{{ ticketId }}</span>
                <span class="checkin-time">Just now</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<app-footer></app-footer>
